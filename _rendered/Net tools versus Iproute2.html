
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Let's-forget-about-net-tools-and-welcome-iproute2">Let's forget about <code>net-tools</code> and welcome <code>iproute2</code><a class="anchor-link" href="#Let's-forget-about-net-tools-and-welcome-iproute2">&#182;</a></h1><p><code>iproute2</code> is a bunch of tools that aim to replace the old commands like <code>ifconfig</code>, <code>route</code> or <code>arp</code> contained in the <code>net-tools</code> package. A lot of people are still using <code>net-tools</code> but as described in <a href="https://lists.debian.org/debian-devel/2009/03/msg00780.html">this official statement</a>, <code>net-tools</code> is intended to deprecation and does not support some new kernel network functionalities. Some linux distribution like Archlinux already <a href="https://www.archlinux.org/news/deprecation-of-net-tools/">deprecated the <code>net-tools</code> utility</a> but still <a href="https://www.archlinux.org/packages/core/i686/net-tools/">provide them in their repository</a> for backward compatibility scripts.</p>
<p>Beside the lack of functionalities, there is also a lack of efficiency in the <code>net-tools</code> package. <code>net-tools</code> commands reads informations from the <code>/proc</code> directory while <code>iproute2</code> uses the Linux kernel interface <a href="https://en.wikipedia.org/wiki/Netlink">Netlink</a> which is much faster.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="An-example-of-iproute2-strenght-versus-net-tools">An example of <code>iproute2</code> strenght versus <code>net-tools</code><a class="anchor-link" href="#An-example-of-iproute2-strenght-versus-net-tools">&#182;</a></h2><p>Let's compare the <code>net-tools</code>' <code>route</code> utility and the <code>ip route</code> utility. In most of the cases, classic routing is enough for what you want to do. For example if you want to modify the default route, both of <code>iproute2</code> and <code>net-tools</code> embed this functionality :</p>
<div class="highlight"><pre><span class="c"># net-tools version :</span>
route add default gw <span class="nv">$ip</span>

<span class="c"># iproute2 version :</span>
ip route add default via <span class="nv">$ip</span>
</pre></div>
<p>However sometimes you do not want to route your packet only based on the destination adresse of a packet. As said in the <a href="http://man7.org/linux/man-pages/man8/ip-rule.8.html"><code>ip rule</code> manual</a> :</p>
<blockquote><p>In some circumstances we want to route packets differently depending not only on destination addresses, but also on other packet fields: source address, IP protocol, transport protocol ports or even packet payload. This task is called <em>'policy routing'</em>.</p>
</blockquote>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Example-of-situation-that-requires-policy-routing">Example of situation that requires policy routing<a class="anchor-link" href="#Example-of-situation-that-requires-policy-routing">&#182;</a></h3><p>Let's say we have the following machine :</p>

<pre><code>+----- Machine ----+      VPN subnet       +-- Router --+
| 'tun0' interface  &gt;--- 10.10.10.0/24 ---&lt;  10.10.10.1 |
|       10.10.10.x |                       +------------+
|                  |
|                  |      WAN subnet       +-- Router --+
|  'wan' interface  &gt;--- 172.17.0.0/24 ---&lt;  172.17.0.1 |
|      172.17.0.2  |                       +------------+
+------------------+</code></pre>
<p>This machine is subject to these constraints :</p>
<ul>
<li>the default route of every packets is over the VPN's router (i.e. <code>10.10.10.1</code>)</li>
<li><strong>only</strong> packets marked <code>32/32</code> (VPN packets and some other packets) must go through the <code>wan</code> interface (<code>32/32</code> is an example).</li>
</ul>
<p>In this situation, the problem is the last constraint. Using the classic routing which is the purpose of <code>net-tools</code>' <code>route</code> utility, you cannot associate a mark to a specific route.</p>
<p>A solution (there are tons of different solutions) is to create a new routing table <code>wan-force</code> in the <code>/etc/iproute2/rt_table</code> :</p>

<pre><code>#
# reserved values
#
255 local
254 main
253 default
0   unspec
#
# local
#
1 wan-force</code></pre>
<p>Then bind every packet marked <code>32/32</code> to the <code>wan-force</code> table using <code>ip rule</code> :</p>
<div class="highlight"><pre>ip rule fwmark <span class="s2">&quot;32/32&quot;</span> priority 16286 lookup wan-force
</pre></div>
<p>If now you list your rules using <code>ip rule list</code>, you will see the different rules and their priority :</p>

<pre><code>0:      from all lookup local 
16286:  from all fwmark 0x20/0x20 lookup wan-force 
32766:  from all lookup main 
32767:  from all lookup default</code></pre>
<p>Finally add the default routes in the <code>wan-force</code> and the main table</p>
<div class="highlight"><pre>ip route add default via <span class="s2">&quot;172.17.0.1&quot;</span> table wan-force
ip route add default via <span class="s2">&quot;10.10.10.1&quot;</span> <span class="c"># table main is automatically selected</span>
</pre></div>
<p>Now every packet marked <code>32/32</code> will be automatically routed through the <code>wan</code> interface.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="net-tools-and-iproute2-commands-cheatsheet"><code>net-tools</code> and <code>iproute2</code> commands cheatsheet<a class="anchor-link" href="#net-tools-and-iproute2-commands-cheatsheet">&#182;</a></h1><p>It is sometimes hard to get into <code>iproute2</code> when you are used to use the <code>net-tools</code> commands. In order to make it easier, here is a small cheatsheet from the <a href="https://access.redhat.com/sites/default/files/attachments/rh_ip_command_cheatsheet_1214_jcs_print.pdf">Red Hat Entreprise <code>ip</code> command cheatsheet</a>.</p>
<table>
    <tr>
        <th>`net-tools` command</th>
        <th>`iproute2` command</th>
        <th>Command purpose</th>
    </tr>
    <tr>   
        <td>`arp -na`</td>
        <td>`ip neigh`</td>
        <td>Display the neighbour objects (i.e. the arp table)</td>
    </tr>
    <tr>
        <td>`ifconfig`</td>
        <td>`ip link`</td>
        <td>Manage and display the state of all network interfaces</td>
    </tr>
    <tr>
        <td>`ifconfig -a`</td>
        <td>`ip addr show`</td>
        <td>Display IP addresses and propertty information</td>
    </tr>
    <tr>
        <td>`ifconfig -s`</td>
        <td>`ip -s link`</td>
        <td>Display the network statistics per interfaces</td>
    </tr>
    <tr>
        <td>`ifconfig eth0 up|down`</td>
        <td>`ip link set eth0 up|down`</td>
        <td>Enable / disable an interface</td>
    </tr>
    <tr>
        <td>`netstat`</td>
        <td>`ss`</td>
        <td>Display socket statistics (see the Red Hat cheatsheet for some useful options)</td>
    </tr>
    <tr>
        <td>`route [...]`</td>
        <td>`ip route [...] [table {table-name}]`</td>
        <td>Display and alter the routing table(s)</td>
    </tr>
    <tr>
        <td></td>
        <td>`ip rule`</td>
        <td>Display and manage the rules for routing table affectation</td>
    </tr>
</table>
</div>
</div>
</div>