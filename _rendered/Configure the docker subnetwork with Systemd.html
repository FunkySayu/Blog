
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Configure-the-default-docker-network-with-systemd">Configure the default docker network with systemd<a class="anchor-link" href="#Configure-the-default-docker-network-with-systemd">&#182;</a></h1><p>Docker is a really good application for not destroying your system with high dependency applications. This is really useful, especially when you want to have a clean system (as much as possible).</p>
<p>Last day, we were studying databases in my engineering school, and we had to install <code>oracle-xe</code>. I really don't like installing these kinds of things on my system, because it's ugly, it does not work like every other things (no <code>pacman -S oracle-xe</code>) etc. I decided to use Docker to install <code>oracle-xe</code> in a particular environment, instead of directly install it on my system.</p>
<p>The point is that Docker use a bridge interface for running his containers. This bridge interface is pretty useful, except when... your <code>route -n</code> look like this :</p>

<pre><code>root@kripton ~ # route -n
0.0.0.0         172.17.0.1      0.0.0.0         UG    202    0        0 eno1
0.0.0.0         172.17.0.1      0.0.0.0         UG    0      0        0 docker0
172.17.0.1      0.0.0.0         255.255.0.0     U     202    0        0 docker0

</code></pre>
<p>Because the Docker's route is more specific than your default route (the <code>eno1</code> route), when you want to connect on a computer in your LAN (let's say <code>172.17.0.24</code>), your system will route the packet through the <code>docker0</code> interface instead of the <code>eno1</code> interface. Conclusion ? You can't connect to this computer. Uuuuuh ;(</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="How-does-it-work-?">How does it work ?<a class="anchor-link" href="#How-does-it-work-?">&#182;</a></h1><p>Docker is a container that manage your dependencies and your application runtime environment. In order to have his own network, it creates a virtual network interface also known as <em>bridged interface</em>. This interface allows you to connect to your application through a secured network, which is... pretty nice.</p>
<p>The bridge interface is created by docker at the daemon startup, and is globally managed by it if you do not configure your own interface. Because it's created by docker, it means that it has default values that might not fill with your system or network configuration.</p>
<p>My issue was here. The docker bridge interface default subnet was <code>172.17.0.0/16</code>, and my school network was on the subnet <code>172.17.0.0/16</code>. Because of this, I couldn't connect to my school VPN, and can not use Internet and Docker at the same time.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Configure-your-bridge-interface">Configure your bridge interface<a class="anchor-link" href="#Configure-your-bridge-interface">&#182;</a></h1><p>If as me you didn't wrote anything in your <code>systemd</code> network management configuration, your <code>/etc/systemd/network</code> is empty. This folder contains all network interface and virtual interface configuration used by the <code>systemd-networkd</code> service in order to configure your network. In order to test your configuration, you can just restart the service :</p>
<div class="highlight"><pre>systemctl restart systemd-networkd
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="How-to-organise-your-/etc/systemd/network-folder-?">How to organise your <code>/etc/systemd/network</code> folder ?<a class="anchor-link" href="#How-to-organise-your-/etc/systemd/network-folder-?">&#182;</a></h2><p>Files are read in alphabetical order. As a lot other configuration folder like that, you should prefix all your files by a number in $[\![00, 99]\!]$.</p>
<p>Files have also 2 different extensions :</p>

<pre><code>*.netdev  for network device creation and setup
*.network for network device configuration

</code></pre>
<p>Before going any further, you should read the <code>man systemd.network</code> and the <code>man systemd.netdev</code>. It's really useful to understand what means every sections and why we use them. Systemd's network configuration does not work like old configuration (through the <code>/etc/network/interfaces</code> file).</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Before-doing-anything,-stop-docker">Before doing anything, stop docker<a class="anchor-link" href="#Before-doing-anything,-stop-docker">&#182;</a></h2><p>You are going to make some huge modifications to the docker infrastructure. That might be harmful for docker, so just stop it before doing anything.</p>
<div class="highlight"><pre>systemctl stop docker
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Create-your-docker's-bridge-network">Create your docker's bridge network<a class="anchor-link" href="#Create-your-docker's-bridge-network">&#182;</a></h2><p>The first thing to do is to create the bridge interface for docker. You can name this bridge as you want, but I like the <code>docker0</code> name (in case you want to have more than one instance of docker running).</p>
<p>In order to create it, you must create a <code>.netdev</code> file containing :</p>
<ul>
<li>the device name (<code>docker0</code> is an example)</li>
<li>the device kind (see <code>man systemd.netdev</code> to see all available device kind)</li>
<li>and if you want a device description.</li>
</ul>

<pre><code>$ cat /etc/systemd/network/20-bridge-docker0.netdev
[NetDev]
Name=docker0
Kind=bridge
Description=Docker bridge network</code></pre>
<h2 id="Configure-your-main(s)-interface(s)">Configure your main(s) interface(s)<a class="anchor-link" href="#Configure-your-main(s)-interface(s)">&#182;</a></h2><p><em>Before</em> configuring your docker bridge, setup your other interfaces. Here is my ethernet network configuration named <code>50-ethernet-dhcp.network</code> file that configure my <code>eno1</code> interface configuration :</p>

<pre><code>$ cat /etc/systemd/network/50-ethernet-dhcp.network
[Match]
Name=eno1

[Network]
DHCP=yes
DNS=8.8.8.8
DNS=8.8.4.4</code></pre>
<p>As you can see, my interface <code>eno1</code> is in DHCP mode. You can also configure it in static mode like this :</p>

<pre><code>$ cat /etc/systemd/network/50-ethernet-static.network
[Match]
Name=eno1

[Network]
Address=192.168.0.15/24
Gateway=192.168.0.1</code></pre>
<h2 id="Configure-your-bridge">Configure your bridge<a class="anchor-link" href="#Configure-your-bridge">&#182;</a></h2><p>Configuring your bridge interface is nearly the same as configuring your basic network interfaces. The main issue is that if you specify a gateway parameter in your configuration (obligatory for docker), it creates a default route for your system. Sometimes this default route overwrite your main interface default route (for me the <code>eno1</code>). The consequence of this is you can't access to internet anymore, which is quite annoying.</p>
<p>So we need a route specific route to access to our network, and we define it into the network configuration file.</p>

<pre><code>$ cat /etc/systemd/network/75-bridge-static.network
[Match]
Name=docker0

[Network]
Address=10.10.254.254/24

[Route]
Gateway=10.10.254.1
Destination=10.10.254.0/24</code></pre>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Tell-docker-which-interface-to-use">Tell docker which interface to use<a class="anchor-link" href="#Tell-docker-which-interface-to-use">&#182;</a></h2><p>The default interface docker use is <code>docker0</code>. But if for some reasons you want to rename this device, you must specificate to docker which device he has to use. I didn't find any other way by now, so here is what I did :</p>

<pre><code># cat /etc/systemd/system/multi-user.target.wants/docker.service 
[Unit]
Description=Docker Application Container Engine
Documentation=https://docs.docker.com
After=network.target docker.socket
Requires=docker.socket

[Service]
Type=notify
ExecStart=/usr/bin/docker daemon -b docker0 -H fd://
MountFlags=slave
LimitNOFILE=1048576
LimitNPROC=1048576
LimitCORE=infinity

[Install]
WantedBy=multi-user.target</code></pre>
<p>The only thing I modificate in this file is the option <code>-d docker0</code> in the <code>Service.ExecStart</code> section. It specify docker to use the <code>docker0</code> bridge controller. And that's it.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Restart-your-networkd-and-check-if-all-is-okay">Restart your networkd and check if all is okay<a class="anchor-link" href="#Restart-your-networkd-and-check-if-all-is-okay">&#182;</a></h2><p>After this, just reload <code>docker</code> and <code>systemd-networkd</code> and you're done !</p>
<div class="highlight"><pre>systemctl restart systemd-networkd
</pre></div>
<p>At this point, your route <em>should</em> look like this :</p>

<pre><code># route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         172.17.0.1      0.0.0.0         UG    202    0        0 eno1
10.10.254.0     0.0.0.0         255.255.255.0   U     0      0        0 docker0
10.10.254.0     10.10.254.1     255.255.255.0   UG    0      0        0 docker0
172.17.0.0      0.0.0.0         255.255.0.0     U     202    0        0 eno1
172.17.0.1      0.0.0.0         255.255.255.255 UH    1024   0        0 eno1</code></pre>
<p>And your interfaces like this :</p>

<pre><code># ip a
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default 
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
2: eno1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether ec:ff:bb:cc:00:22 brd ff:ff:ff:ff:ff:ff
    inet 172.17.7.204/16 brd 172.17.255.255 scope global dynamic eno1
       valid_lft 169262sec preferred_lft 169262sec
    inet 172.17.9.40/16 brd 172.17.255.255 scope global secondary dynamic eno1
       valid_lft 170251sec preferred_lft 170251sec
    inet 172.17.8.133/16 brd 172.17.255.255 scope global secondary eno1
       valid_lft forever preferred_lft forever
    inet6 fe80::d569:a090:c38d:5a6/64 scope link 
       valid_lft forever preferred_lft forever
31: docker0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default 
    link/ether 02:42:f9:ce:3c:c8 brd ff:ff:ff:ff:ff:ff
    inet 10.10.254.254/24 brd 10.10.254.255 scope global docker0
       valid_lft forever preferred_lft forever
    inet6 fe80::d252:9a4:c734:a541/64 scope link 
       valid_lft forever preferred_lft forever</code></pre>
<p><em>Little point</em> : sometimes, the interface <code>docker0</code> might keep some traces of the old configuration (setup by docker). You might have something like this :</p>

<pre><code># ip a
.../...
31: docker0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default 
    link/ether 02:42:f9:ce:3c:c8 brd ff:ff:ff:ff:ff:ff
    inet 10.10.254.254/24 brd 10.10.254.255 scope global docker0
       valid_lft forever preferred_lft forever
    inet 172.17.0.1/24 brd 172.17.0.255 scope global docker0
       valid_lft forever preferred_lft forever
    inet6 fe80::d252:9a4:c734:a541/64 scope link 
       valid_lft forever preferred_lft forever</code></pre>
<p>In order to delete this, just tell ip to delete the address on your bridge interface</p>
<div class="highlight"><pre>ip addr del 127.17.0.1/24 dev docker0
</pre></div>
<p>You're done with this part if :</p>
<ul>
<li>your bridged interface is configured on the expected sub-network (for example <code>10.10.254.254/24</code>)</li>
<li>you have a route that points to this sub-network as this :</li>
</ul>

<pre><code>    Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
    10.10.254.0     10.10.254.1     255.255.255.0   UG    0      0        0 docker0</code></pre>
<ul>
<li>you do NOT have a default route using your bridge network</li>
<li>your default route use your main interface like this</li>
</ul>

<pre><code>    Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
    0.0.0.0         172.17.0.1      0.0.0.0         UG    202    0        0 eno1</code></pre>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Time-to-restart-docker-and-enjoy-!">Time to restart docker and enjoy !<a class="anchor-link" href="#Time-to-restart-docker-and-enjoy-!">&#182;</a></h2><p>You can now restart docker.</p>
<div class="highlight"><pre>systemctl restart docker
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Any-issues-?">Any issues ?<a class="anchor-link" href="#Any-issues-?">&#182;</a></h1><p>Please tell me !</p>

</div>
</div>
</div>